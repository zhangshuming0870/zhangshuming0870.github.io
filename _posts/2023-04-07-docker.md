---
layout: post
title: "æœ¬åœ°é¡¹ç›®dockeréƒ¨ç½²"
date: 2023-04-07
categories: [åç«¯]
tags: [docker, æœ¬åœ°å¼€å‘]
author: zhangshuming
---

# Docker å®Œæ•´æŒ‡å— - åŸºäºOpenLayersé¡¹ç›®æ¡ˆä¾‹

## ç›®å½•

1. [Dockerå®‰è£…](#dockerå®‰è£…)
2. [DockeråŸºç¡€æ¦‚å¿µ](#dockeråŸºç¡€æ¦‚å¿µ)
3. [é¡¹ç›®DockeråŒ–](#é¡¹ç›®dockeråŒ–)
4. [ç”Ÿäº§ç¯å¢ƒæ‰“åŒ…éƒ¨ç½²](#ç”Ÿäº§ç¯å¢ƒæ‰“åŒ…éƒ¨ç½²)
5. [å¼€å‘ç¯å¢ƒé…ç½®](#å¼€å‘ç¯å¢ƒé…ç½®)
6. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
7. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## Dockerå®‰è£…

### macOSå®‰è£…

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨Homebrewï¼ˆæ¨èï¼‰
```bash
# å®‰è£…Docker Desktop
brew install --cask docker

# å¯åŠ¨Docker Desktop
open -a Docker
```

#### æ–¹æ³•äºŒï¼šå®˜æ–¹å®‰è£…åŒ…
1. è®¿é—® [Dockerå®˜ç½‘](https://www.docker.com/products/docker-desktop)
2. ä¸‹è½½macOSç‰ˆæœ¬çš„Docker Desktop
3. åŒå‡»å®‰è£…åŒ…è¿›è¡Œå®‰è£…
4. å¯åŠ¨Docker Desktop

### éªŒè¯å®‰è£…
```bash
# æ£€æŸ¥Dockerç‰ˆæœ¬
docker --version

# æ£€æŸ¥Dockeræ˜¯å¦æ­£å¸¸è¿è¡Œ
docker ps

# è¿è¡Œæµ‹è¯•å®¹å™¨
docker run hello-world
```

### å¯åŠ¨Docker Desktop
```bash
# å‘½ä»¤è¡Œå¯åŠ¨
open -a Docker

# æˆ–ç›´æ¥å¯åŠ¨
/Applications/Docker.app/Contents/MacOS/Docker
```

---

## DockeråŸºç¡€æ¦‚å¿µ

### æ ¸å¿ƒç»„ä»¶

1. **Dockerfile** - é•œåƒæ„å»ºè„šæœ¬
2. **Docker Image** - é•œåƒæ–‡ä»¶
3. **Docker Container** - è¿è¡Œä¸­çš„å®¹å™¨
4. **Docker Compose** - å¤šå®¹å™¨ç¼–æ’å·¥å…·

### åŸºæœ¬å‘½ä»¤
```bash
# æ„å»ºé•œåƒ
docker build -t é•œåƒå .

# è¿è¡Œå®¹å™¨
docker run -d -p å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£ é•œåƒå

# æŸ¥çœ‹è¿è¡Œä¸­çš„å®¹å™¨
docker ps

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨
docker ps -a

# åœæ­¢å®¹å™¨
docker stop å®¹å™¨å

# åˆ é™¤å®¹å™¨
docker rm å®¹å™¨å

# åˆ é™¤é•œåƒ
docker rmi é•œåƒå
```

---

## é¡¹ç›®DockeråŒ–

### 1. é¡¹ç›®åˆ†æ

æˆ‘ä»¬çš„OpenLayersé¡¹ç›®ç»“æ„ï¼š
```
test-openlayers/
â”œâ”€â”€ index.html          # å…¥å£HTMLæ–‡ä»¶
â”œâ”€â”€ package.json        # é¡¹ç›®ä¾èµ–é…ç½®
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts         # ä¸»å…¥å£æ–‡ä»¶
â”‚   â””â”€â”€ style.css       # æ ·å¼æ–‡ä»¶
â”œâ”€â”€ tsconfig.json       # TypeScripté…ç½®
â””â”€â”€ vite.config.ts      # Viteæ„å»ºé…ç½®
```

### 2. åˆ›å»ºDockerfile

#### ç”Ÿäº§ç¯å¢ƒDockerfile
```dockerfile
# å¤šé˜¶æ®µæ„å»º - æ„å»ºé˜¶æ®µ
FROM node:18-alpine AS builder

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶package.jsonå’Œpackage-lock.json
COPY package*.json ./

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼Œç”¨äºæ„å»ºï¼‰
RUN npm ci

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºé¡¹ç›®
RUN npm run build

# ç”Ÿäº§é˜¶æ®µ - ä½¿ç”¨nginxæœåŠ¡é™æ€æ–‡ä»¶
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©åˆ°nginxç›®å½•
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶nginxé…ç½®æ–‡ä»¶
COPY nginx.conf /etc/nginx/nginx.conf

# æš´éœ²ç«¯å£
EXPOSE 80

# å¯åŠ¨nginx
CMD ["nginx", "-g", "daemon off;"]
```

#### å¼€å‘ç¯å¢ƒDockerfile
```dockerfile
# å¼€å‘ç¯å¢ƒDockerfile
FROM node:18-alpine

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶package.jsonå’Œpackage-lock.json
COPY package*.json ./

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼‰
RUN npm ci

# å¤åˆ¶æºä»£ç 
COPY . .

# æš´éœ²å¼€å‘æœåŠ¡å™¨ç«¯å£
EXPOSE 5173

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
```

### 3. åˆ›å»ºé…ç½®æ–‡ä»¶

#### nginx.conf
```nginx
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;

    # åŸºæœ¬è®¾ç½®
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    server {
        listen 80;
        server_name localhost;
        root /usr/share/nginx/html;
        index index.html;

        # å¤„ç†é™æ€æ–‡ä»¶
        location / {
            try_files $uri $uri/ /index.html;
        }

        # ç¼“å­˜é™æ€èµ„æº
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # å®‰å…¨å¤´
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }
}
```

#### .dockerignore
```
node_modules
npm-debug.log
.git
.gitignore
README.md
.env
.env.local
.env.development.local
.env.test.local
.env.production.local
.DS_Store
*.log
dist
coverage
.vscode
.idea
```

### 4. Docker Composeé…ç½®

#### ç”Ÿäº§ç¯å¢ƒ (docker-compose.yml)
```yaml
version: '3.8'

services:
  openlayers-app:
    build: .
    ports:
      - "8080:80"
    container_name: openlayers-test-app
    restart: unless-stopped
    environment:
      - NODE_ENV=production
    volumes:
      # å¯é€‰ï¼šæŒ‚è½½æ—¥å¿—ç›®å½•
      - ./logs:/var/log/nginx
```

#### å¼€å‘ç¯å¢ƒ (docker-compose.dev.yml)
```yaml
version: '3.8'

services:
  openlayers-app-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    container_name: openlayers-test-app-dev
    volumes:
      # æŒ‚è½½æºä»£ç ç›®å½•ï¼Œå®ç°çƒ­é‡è½½
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
    stdin_open: true
    tty: true
```

---

## ç”Ÿäº§ç¯å¢ƒæ‰“åŒ…éƒ¨ç½²

### æ­¥éª¤1ï¼šå‡†å¤‡é¡¹ç›®

ç¡®ä¿é¡¹ç›®ä¾èµ–å·²æ­£ç¡®å®‰è£…ï¼š
```bash
# æ£€æŸ¥ä¾èµ–
npm ls openlayers-quick-tools

# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
npm install
```

### æ­¥éª¤2ï¼šæ„å»ºDockeré•œåƒ

```bash
# æ„å»ºç”Ÿäº§ç¯å¢ƒé•œåƒ
docker build -t openlayers-test-app .

# æŸ¥çœ‹æ„å»ºçš„é•œåƒ
docker images
```

### æ­¥éª¤3ï¼šè¿è¡Œå®¹å™¨

```bash
# è¿è¡Œç”Ÿäº§å®¹å™¨
docker run -d --name openlayers-test-app -p 8080:80 openlayers-test-app

# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
docker ps

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs openlayers-test-app
```

### æ­¥éª¤4ï¼šè®¿é—®åº”ç”¨

æ„å»ºå®Œæˆåï¼Œåº”ç”¨å°†åœ¨ä»¥ä¸‹åœ°å€å¯ç”¨ï¼š
- **æœ¬åœ°è®¿é—®**: http://localhost:8080
- **å®¹å™¨å†…è®¿é—®**: http://localhost:80

### è‡ªåŠ¨åŒ–è„šæœ¬

åˆ›å»º `build-and-run.sh` è„šæœ¬ï¼š
```bash
#!/bin/bash

# OpenLayersé¡¹ç›®Dockeræ„å»ºå’Œè¿è¡Œè„šæœ¬

echo "ğŸš€ å¼€å§‹æ„å»ºOpenLayersé¡¹ç›®Dockeré•œåƒ..."

# æ„å»ºDockeré•œåƒ
docker build -t openlayers-test-app .

if [ $? -eq 0 ]; then
    echo "âœ… Dockeré•œåƒæ„å»ºæˆåŠŸï¼"
    
    # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    docker stop openlayers-test-app 2>/dev/null || true
    docker rm openlayers-test-app 2>/dev/null || true
    
    # è¿è¡Œæ–°å®¹å™¨
    echo "ğŸŒ å¯åŠ¨å®¹å™¨..."
    docker run -d \
        --name openlayers-test-app \
        -p 8080:80 \
        --restart unless-stopped \
        openlayers-test-app
    
    if [ $? -eq 0 ]; then
        echo "âœ… å®¹å™¨å¯åŠ¨æˆåŠŸï¼"
        echo "ğŸ“± åº”ç”¨å·²éƒ¨ç½²åˆ°: http://localhost:8080"
        echo "ğŸ” æŸ¥çœ‹å®¹å™¨çŠ¶æ€: docker ps"
        echo "ğŸ“‹ æŸ¥çœ‹å®¹å™¨æ—¥å¿—: docker logs openlayers-test-app"
    else
        echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥ï¼"
        exit 1
    fi
else
    echo "âŒ Dockeré•œåƒæ„å»ºå¤±è´¥ï¼"
    exit 1
fi
```

ä½¿ç”¨è„šæœ¬ï¼š
```bash
# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x build-and-run.sh

# è¿è¡Œè„šæœ¬
./build-and-run.sh
```

---

## å¼€å‘ç¯å¢ƒé…ç½®

### å¯åŠ¨å¼€å‘ç¯å¢ƒ

```bash
# ä½¿ç”¨Docker Composeå¯åŠ¨å¼€å‘ç¯å¢ƒ
docker-compose -f docker-compose.dev.yml up -d

# æŸ¥çœ‹å¼€å‘ç¯å¢ƒæ—¥å¿—
docker-compose -f docker-compose.dev.yml logs -f

# è¿›å…¥å¼€å‘å®¹å™¨
docker exec -it openlayers-test-app-dev sh
```

### å¼€å‘ç¯å¢ƒç‰¹æ€§

- **çƒ­é‡è½½**: ä»£ç ä¿®æ”¹åè‡ªåŠ¨åˆ·æ–°
- **æºç æ˜ å°„**: æ”¯æŒæµè§ˆå™¨è°ƒè¯•
- **å®æ—¶ç¼–è¯‘**: TypeScriptå®æ—¶ç¼–è¯‘
- **å·¥å…·**: å®Œæ•´çš„å·¥å…·é“¾

### è®¿é—®å¼€å‘ç¯å¢ƒ

- **æœ¬åœ°è®¿é—®**: http://localhost:5173
- **å®¹å™¨å†…è®¿é—®**: http://localhost:5173

---

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 1. Dockerå®ˆæŠ¤è¿›ç¨‹æœªè¿è¡Œ

**é—®é¢˜**: `Cannot connect to the Docker daemon`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å¯åŠ¨Docker Desktop
open -a Docker

# ç­‰å¾…å¯åŠ¨å®ŒæˆåéªŒè¯
docker ps
```

### 2. æ„å»ºå¤±è´¥ - ä¾èµ–é—®é¢˜

**é—®é¢˜**: `Cannot find module 'xxx'`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ç¡®ä¿package.jsonåŒ…å«æ‰€æœ‰ä¾èµ–
npm install

# é‡æ–°æ„å»º
docker build -t openlayers-test-app .
```

### 3. ç«¯å£å†²çª

**é—®é¢˜**: `port is already allocated`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
lsof -i :8080

# åœæ­¢å ç”¨ç«¯å£çš„å®¹å™¨
docker stop å®¹å™¨å

# æˆ–ä½¿ç”¨å…¶ä»–ç«¯å£
docker run -d -p 8081:80 openlayers-test-app
```

### 4. å®¹å™¨å¯åŠ¨å¤±è´¥

**é—®é¢˜**: å®¹å™¨å¯åŠ¨åç«‹å³é€€å‡º

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs openlayers-test-app

# æ£€æŸ¥nginxé…ç½®
docker exec -it openlayers-test-app nginx -t

# è¿›å…¥å®¹å™¨è°ƒè¯•
docker exec -it openlayers-test-app sh
```

### 5. é™æ€æ–‡ä»¶æ— æ³•è®¿é—®

**é—®é¢˜**: 404é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥æ„å»ºäº§ç‰©
docker exec -it openlayers-test-app ls -la /usr/share/nginx/html

# æ£€æŸ¥nginxé…ç½®
docker exec -it openlayers-test-app cat /etc/nginx/nginx.conf
```

### 6. å†…å­˜ä¸è¶³

**é—®é¢˜**: æ„å»ºè¿‡ç¨‹ä¸­å†…å­˜ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å¢åŠ Dockerå†…å­˜é™åˆ¶
# åœ¨Docker Desktopè®¾ç½®ä¸­è°ƒæ•´å†…å­˜é™åˆ¶

# æˆ–ä½¿ç”¨æ›´å°çš„åŸºç¡€é•œåƒ
FROM node:18-alpine AS builder
```

---

## æœ€ä½³å®è·µ

### 1. é•œåƒä¼˜åŒ–

- **å¤šé˜¶æ®µæ„å»º**: å‡å°‘æœ€ç»ˆé•œåƒå¤§å°
- **ä½¿ç”¨AlpineåŸºç¡€é•œåƒ**: è½»é‡çº§Linuxå‘è¡Œç‰ˆ
- **åˆå¹¶RUNå‘½ä»¤**: å‡å°‘é•œåƒå±‚æ•°
- **æ¸…ç†ç¼“å­˜**: åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶

### 2. å®‰å…¨è€ƒè™‘

- **érootç”¨æˆ·**: ä½¿ç”¨éç‰¹æƒç”¨æˆ·è¿è¡Œå®¹å™¨
- **æœ€å°æƒé™**: åªå®‰è£…å¿…è¦çš„åŒ…
- **å®‰å…¨æ‰«æ**: å®šæœŸæ‰«æé•œåƒæ¼æ´
- **æ›´æ–°åŸºç¡€é•œåƒ**: åŠæ—¶æ›´æ–°å®‰å…¨è¡¥ä¸

### 3. æ€§èƒ½ä¼˜åŒ–

- **ç¼“å­˜ä¾èµ–**: åˆç†åˆ©ç”¨Dockerå±‚ç¼“å­˜
- **å‹ç¼©é™æ€èµ„æº**: å¯ç”¨Gzipå‹ç¼©
- **CDNåŠ é€Ÿ**: ä½¿ç”¨CDNåŠ é€Ÿé™æ€èµ„æº
- **è´Ÿè½½å‡è¡¡**: å¤šå®ä¾‹éƒ¨ç½²

### 4. ç›‘æ§å’Œæ—¥å¿—

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats openlayers-test-app

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs -f openlayers-test-app

# æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯
docker inspect openlayers-test-app
```

### 5. å¤‡ä»½å’Œæ¢å¤

```bash
# å¯¼å‡ºé•œåƒ
docker save openlayers-test-app > openlayers-test-app.tar

# å¯¼å…¥é•œåƒ
docker load < openlayers-test-app.tar

# å¤‡ä»½å®¹å™¨æ•°æ®
docker cp openlayers-test-app:/usr/share/nginx/html ./backup
```

### 6. ç”Ÿäº§éƒ¨ç½²å»ºè®®

1. **ä½¿ç”¨HTTPS**: é…ç½®SSLè¯ä¹¦
2. **è´Ÿè½½å‡è¡¡**: ä½¿ç”¨nginxæˆ–äº‘æœåŠ¡å•†è´Ÿè½½å‡è¡¡å™¨
3. **ç›‘æ§**: é…ç½®æ—¥å¿—æ”¶é›†å’Œç›‘æ§
4. **å¤‡ä»½**: å®šæœŸå¤‡ä»½æ•°æ®å’Œé…ç½®
5. **CI/CD**: é›†æˆè‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹
6. **å®¹å™¨ç¼–æ’**: ä½¿ç”¨Kubernetesæˆ–Docker Swarm

---

## æ€»ç»“

é€šè¿‡æœ¬æŒ‡å—ï¼Œæˆ‘ä»¬å®Œæˆäº†OpenLayersé¡¹ç›®çš„å®Œæ•´DockeråŒ–ï¼š

1. âœ… **Dockerå®‰è£…å’Œé…ç½®**
2. âœ… **é¡¹ç›®DockeråŒ–**
3. âœ… **ç”Ÿäº§ç¯å¢ƒæ‰“åŒ…éƒ¨ç½²**
4. âœ… **å¼€å‘ç¯å¢ƒé…ç½®**
5. âœ… **é—®é¢˜æ’æŸ¥å’Œä¼˜åŒ–**

å…³é”®è¦ç‚¹ï¼š
- ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–é•œåƒå¤§å°
- é…ç½®nginxæä¾›ç”Ÿäº§çº§æœåŠ¡
- æ”¯æŒå¼€å‘ç¯å¢ƒçƒ­é‡è½½
- æä¾›å®Œæ•´çš„éƒ¨ç½²è„šæœ¬å’Œæ–‡æ¡£

è¿™ä¸ªæ¡ˆä¾‹å±•ç¤ºäº†ç°ä»£å‰ç«¯é¡¹ç›®çš„å®Œæ•´DockeråŒ–æµç¨‹ï¼Œå¯ä»¥ä½œä¸ºå…¶ä»–é¡¹ç›®çš„å‚è€ƒæ¨¡æ¿ã€‚

---

*æœ¬æ–‡æ¡£åŸºäºOpenLayersé¡¹ç›®æ¡ˆä¾‹ï¼Œè¯¦ç»†è®°å½•äº†Dockerçš„å®‰è£…ã€ä½¿ç”¨å’Œéƒ¨ç½²è¿‡ç¨‹ã€‚* 